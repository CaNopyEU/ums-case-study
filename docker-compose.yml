version: '3.8'

services:
  db:
    image: clue/json-server
    container_name: ums-db
    ports:
      - "${DB_PORT:-3000}:80"
    volumes:
      - ./db/db.json:/data/db.json
    networks:
      - ums-network
    env_file:
      - .env

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: ums-server
    ports:
      - "${GRPC_PORT:-8081}:8081"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DB_URL=${DB_URL:-http://db:80}
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      - BCRYPT_SALT_ROUNDS=${BCRYPT_SALT_ROUNDS:-10}
      - GRPC_PORT=8081
    env_file:
      - .env
    depends_on:
      - db
    networks:
      - ums-network
    volumes:
      - ./server/src:/app/src
    restart: unless-stopped

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: ums-client
    ports:
      - "${CLIENT_PORT:-8091}:8091"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - GRPC_SERVER_URL=${GRPC_SERVER_URL:-server:8081}
      - PORT=8091
    env_file:
      - .env
    depends_on:
      - server
    networks:
      - ums-network
    volumes:
      - ./client/src:/app/src
      - ./client/users-init.json:/app/users-init.json
    restart: unless-stopped

networks:
  ums-network:
    driver: bridge
